# id: 51
# https://demo.kestra.io/ui/blueprints/community/51
# http://localhost:8080/ui/blueprints/51
# Git workflow for dbt with Postgres
# Tags: Git, dbt, Postgres
description: |
  This flow:
  - clones a dbt Git repository from GitHub, 
  - pulls a public container image with the required dependencies from https://github.com/dbt-labs/dbt-core/pkgs/container/dbt-postgres
  - runs dbt CLI commands in a Docker container.


id: 51_dbtGitDockerPostgres
namespace: blueprint

tasks:
  - id: dbt
    type: io.kestra.core.tasks.flows.WorkingDirectory
    tasks:
    - id: cloneRepository
      type: io.kestra.plugin.git.Clone
      url: https://github.com/kestra-io/dbt-demo
      branch: main

    - id: dbt-build
      type: io.kestra.plugin.dbt.cli.Build
      runner: DOCKER
      dbtPath: /usr/local/bin/dbt
      dockerOptions:
        image: ghcr.io/kestra-io/dbt-postgres:latest
      inputFiles:
        .profile/profiles.yml: |
          jaffle_shop:
            outputs:
              dev:
                type: postgres
                host: myhostname.eu-central-1.rds.amazonaws.com
                user: kestra
                password: "{{secret('POSTGRES_PASSWORD')}}"
                port: 5432
                dbname: postgres
                schema: public
                threads: 4
                connect_timeout: 10
            target: dev
