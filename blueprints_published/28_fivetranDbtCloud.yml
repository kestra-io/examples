# id: 28
# https://demo.kestra.io/ui/blueprints/community/28
# http://localhost:8080/ui/blueprints/28
# Trigger multiple Fivetran syncs in parallel, then run a dbt Cloud job
# Tags: Ingest, Parallel, dbt
description: |
  This flow will sync data from multiple sources using Fivetran and then trigger a dbt Cloud job.
  
  Given that you may have tens or hundreds of Fivetran connectors that need to be synced before running dbt, `taskDefaults` property is used to avoid boilerplate configuration.
  
  The `wait` flag on the dbt Cloud job task is set to `true` allowing to capture logs and job status and ensuring that dynamically generated tasks (based on dbt models and tests) will be displayed in the Gantt view. This will also ensure that Kestra will wait for the dbt Cloud job to finish before continuing any downstream tasks, and it will fail the execution if dbt Cloud job fails.

id: 28_fivetranDbtCloud
namespace: blueprint

tasks:
  - id: fivetran-syncs
    type: io.kestra.core.tasks.flows.Parallel
    tasks:
      - id: salesforce
        type: io.kestra.plugin.fivetran.connectors.Sync
        connectorId: "enterYourFivetranConnectorId"
      - id: google-analytics
        type: io.kestra.plugin.fivetran.connectors.Sync
        connectorId: "enterYourFivetranConnectorId"
      - id: facebook
        type: io.kestra.plugin.fivetran.connectors.Sync
        connectorId: "enterYourFivetranConnectorId"

  - id: dbt-cloud-job
    type: io.kestra.plugin.dbt.cloud.TriggerRun
    jobId: "396284"
    accountId: "{{ secret('DBT_CLOUD_ACCOUNT_ID') }}"
    token: "{{ secret('DBT_CLOUD_API_TOKEN') }}"
    wait: true

taskDefaults:
  - type: io.kestra.plugin.fivetran.connectors.Sync
    values:
      apiKey: "{{ secret('FIVETRAN_API_KEY') }}"
      apiSecret: "{{ secret('FIVETRAN_API_SECRET') }}"
