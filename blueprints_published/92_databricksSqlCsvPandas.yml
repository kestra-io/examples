# id: 92
# https://demo.kestra.io/ui/blueprints/community/92
# http://localhost:8080/ui/blueprints/92
# Run a SQL query on Databricks and process the results in a Python script
# Tags: Databricks Python
description: |
  This flow demonstrates how to run a SQL query on a Databricks lakehouse. The results are stored in a CSV file. Then, the flow uses Pandas to read the CSV file and further process the data.

id: 92_databricksSql
namespace: blueprint

tasks:
  - id: sqlQuery
    type: io.kestra.plugin.databricks.sql.Query
    accessToken: "{{ secret('DATABRICKS_TOKEN') }}"
    host: "{{ secret('DATABRICKS_HOST') }}"
    httpPath: sql/protocolv1/o/3497567377305430/0713-130754-9oa8zceh
    sql: SELECT * FROM samples.nyctaxi.trips LIMIT 100;
    store: true

  - id: csv
    type: io.kestra.plugin.serdes.csv.CsvWriter
    from: "{{ outputs.sqlQuery.uri }}"

  - id: pandas
    type: io.kestra.plugin.scripts.python.Script
    beforeCommands:
      - pip install kestra pandas > /dev/null
    script: |
      import pandas as pd

      df = pd.read_csv("{{outputs.csv.uri}}")
      df.head()