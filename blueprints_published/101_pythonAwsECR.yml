# id: 101
# https://demo.kestra.io/ui/blueprints/community/101
# http://localhost:8080/ui/blueprints/101
# Pull a container image from Amazon ECR registry and run a Python script
# Tags: AWS, Docker, Python, CLI
description: |
  This flow will retrieve an authorization token to authenticate with the Amazon ECR. Then, it will pull the specified image and will run a Python script (or whichever command you wish) in a Docker container. 

id: 101_pythonAwsECR
namespace: blueprint

tasks:
  - id: aws
    type: io.kestra.plugin.aws.cli.AwsCLI
    accessKeyId: "{{ secret('AWS_ACCESS_KEY_ID') }}"
    secretKeyId: "{{ secret('AWS_SECRET_ACCESS_KEY') }}"
    region: "{{ secret('AWS_DEFAULT_REGION') }}"
    commands:
      - TOKEN=$(aws ecr get-authorization-token --output text --query 'authorizationData[].authorizationToken' | base64 --decode | cut -d':' -f2)
      - echo "::{\"outputs\":{\"token\":\"$TOKEN\"}}::"

  - id: py
    type: io.kestra.plugin.scripts.python.Commands
    docker:
      image: 338306982838.dkr.ecr.eu-central-1.amazonaws.com/data-infastructure:latest
      config: |
        {
          "auths": {
            "338306982838.dkr.ecr.eu-central-1.amazonaws.com": {
                "username": "AWS",
                "password": "{{outputs.aws.vars.token}}"
              }
          }
        }
    commands:
      - python --version # e.g. python yourscript.py
