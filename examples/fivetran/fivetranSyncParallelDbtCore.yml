id: fivetran_sync_parallel_dbt_core
namespace: company.team
description: |
    This flow runs Fivetran syncs in parallel and then runs dbt core's CLI commands.
    The Fivetran API credentials, referenced in the `pluginDefaults`, must be provided in the environment variables.

tasks:
  - id: data_ingestion
    type: io.kestra.plugin.core.flow.Parallel
    tasks:
      - id: salesforce
        type: io.kestra.plugin.fivetran.connectors.Sync
        connectorId: vehicle_movement

      - id: stripe
        type: io.kestra.plugin.fivetran.connectors.Sync
        connectorId: cell_delivery

      - id: google_analytics
        type: io.kestra.plugin.fivetran.connectors.Sync
        connectorId: equivocal_sandy

      - id: facebook_ads
        type: io.kestra.plugin.fivetran.connectors.Sync
        connectorId: molecule_transport

  - id: dbt_core
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
      - id: clone_repository
        type: io.kestra.plugin.git.Clone
        url: https://github.com/dbt-labs/jaffle_shop
        branch: main

      - id: dbt_setup
        type: io.kestra.plugin.dbt.cli.Setup
        profiles:
          jaffle_shop:
            outputs:
              dev:
                type: bigquery
                dataset: dwh
                fixed_retries: 1
                keyfile: sa.json
                location: EU
                method: service-account
                priority: interactive
                project: geller
                threads: 8
                timeout_seconds: 300
            target: dev
        requirements:
          - dbt-bigquery
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:3.10-slim
        inputFiles:
          sa.json: "{{ secret('GCP_SERVICE_ACCOUNT_JSON') }}"

      - id: dbt_build
        type: io.kestra.plugin.dbt.cli.Build
        debug: false
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:3.10-slim
        inputFiles:
          sa.json: "{{ secret('GCP_SERVICE_ACCOUNT_JSON') }}"

pluginDefaults:
  - type: io.kestra.plugin.fivetran.connectors.Sync
    values:
      apiKey: "{{ secret('FIVETRAN_API_KEY') }}"
      apiSecret: "{{ secret('FIVETRAN_API_SECRET') }}"
