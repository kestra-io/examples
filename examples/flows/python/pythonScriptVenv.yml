id: python_script_venv
namespace: company.team
description: |
  This flow creates a CSV file from a CLI using a Bash task.
  It then processes it in Python with `pandas` in a virtual environment.
  Finally, it collects metrics (orders, sales) from the data processing task.

tasks:
  - id: csv
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
      - id: extract_csv
        type: io.kestra.plugin.scripts.shell.Commands
        description: Create a CSV file
        commands:
          - echo "order_id,total_amount" > output.csv
          - echo "1,100" >> output.csv
          - echo "2,200" >> output.csv
          - echo "3,300" >> output.csv
          - echo Generated the CSV file âœ…

      - id: process_csv
        type: io.kestra.plugin.scripts.python.Script
        beforeCommands:
          - pip install pandas==1.5.3
        script: |
          from kestra import Kestra
          import pandas as pd
          
          df = pd.read_csv("output.csv")
          orders = df["order_id"].count()
          sales = df["total_amount"].sum()
          print(f"there are {orders} orders with total sales of {sales}")
          
          tags = dict(dashboard="sales")
          Kestra.counter("orders", int(orders), tags)
          Kestra.counter("sales", int(sales), tags)
