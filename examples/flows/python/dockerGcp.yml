id: python_docker_gcp
namespace: blueprint

tasks:
  - id: wdir
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
      - id: download_csv
        type: io.kestra.plugin.fs.http.Download
        uri: https://raw.githubusercontent.com/kestra-io/datasets/main/csv/orders.csv

      - id: fetch_auth_token
        type: io.kestra.plugin.gcp.auth.OauthAccessToken
        projectId: YOUR_GCP_PROJECT_NAME
        serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT_JSON') }}"

      - id: analyze_sales
        type: io.kestra.plugin.scripts.python.Script
        inputFiles:
          data.csv: "{{ outputs.download_csv.uri }}"
        script: |
          import pandas as pd
          from kestra import Kestra

          df = pd.read_csv("data.csv")
          sales = df.total.sum()
          med = df.quantity.median()

          Kestra.outputs({"total_sales": sales, "median_quantity": med})

          top_sellers = df.sort_values(by="total", ascending=False).head(3)
          print(f"Top 3 orders: {top_sellers}")
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: yourGcpRegion-docker.pkg.dev/YOUR_GCP_PROJECT_NAME/flows/python:latest
        config: |
          {
            "auths": {
              "europe-west3-docker.pkg.dev": {
                  "username": "oauth2accesstoken",
                  "password": "{{outputs.fetchAuthToken.accessToken.tokenValue}}"
                }
            }
          }
