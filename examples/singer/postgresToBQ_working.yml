id: postgres_to_bigquery_singer
namespace: company.team
description: |
  This flow will extract raw data from a Postgres database and load it into BigQuery using the Singer protocol.
  The credentials to both Postgres and BigQuery can be provided as environment variables.

tasks:
  - id: extract
    type: io.kestra.plugin.singer.taps.PipelinewisePostgres
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
    containerImage: python:3.8
    host: host.docker.internal
    port: 5432
    dbName: postgres
    username: postgres
    password: "{{ secret('DB_PASSWORD') }}"
    streamsConfigurations:
      - replicationMethod: FULL_TABLE # FULL_TABLE, INCREMENTAL, LOG_BASED
#        replicationKeys: last_updated # Incremental load always needs replication key
#        selected: true
#        stream: string
#        propertiesPattern: list of strings

  - id: bigquery_target
    type: io.kestra.plugin.singer.targets.AdswerveBigQuery
    addMetadataColumns: true
    datasetId: singer
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
    containerImage: python:3.8
    from: "{{ outputs.extract.raw }}"
    location: EU
    projectId: geller
    serviceAccount: "{{ secret('GCP_SERVICE_ACCOUNT_JSON') }}"
