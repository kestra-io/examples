id: s3_map_over_objects
namespace: company.team

inputs:
  - name: bucket
    type: STRING
    defaults: declarative-data-orchestration

tasks:
  - id: list_objects
    type: io.kestra.plugin.aws.s3.List
    bucket: "{{inputs.bucket}}"
    prefix: powerplant/

  - id: print_objects
    type: io.kestra.core.tasks.log.Log
    message: "found objects {{ outputs.list_objects.objects }}"

  - id: map_over_s3_objects
    type: io.kestra.core.tasks.flows.ForEach
    concurrencyLimit: 0
    values: "{{ outputs.list_objects.objects }}"
    tasks: # all tasks listed here will run in parallel
      - id: filename
        type: io.kestra.core.tasks.log.Log
        message: "filename {{ json(taskrun.value).key }} with size {{ json(taskrun.value).size }}"

pluginDefaults:
  - type: io.kestra.plugin.aws.s3.List
    values:
      accessKeyId: "{{ secret('AWS_ACCESS_KEY_ID') }}"
      secretKeyId: "{{ secret('AWS_SECRET_ACCESS_KEY') }}"
      region: "{{ secret('AWS_DEFAULT_REGION') }}"
